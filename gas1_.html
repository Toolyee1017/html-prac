<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>水底危機</title>
    <style>
        /* CSS 樣式 */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f8ff;
        }
        .container {
            width: 700px;
            border: 3px solid #333;
            text-align: center;
            background-color: #fff;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-radius: 10px;
        }
        #game-screen {
            width: 100%;
            height: 300px;
            border: 1px solid #ccc;
            position: relative; 
            overflow: hidden;
            margin: 20px 0;
            display: flex;
            flex-direction: column;
        }
        #surface {
            height: 50%;
            background-color: #87CEEB;
            border-bottom: 2px dashed #00008B;
        }
        #underwater {
            height: 50%;
            background-color: #4682B4;
        }
        .player {
            width: 45px;
            height: 45px;
            background-color: #FFD700;
            border: 2px solid #333;
            border-radius: 50%;
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.1em;
            font-weight: bold;
            top: 25%; 
            transform: translate(-50%, -50%);
            transition: top 0.5s ease-in-out, background-color 0.3s ease; 
        }
        .player.submerged { top: 75%; }
        .player.dead { background-color: #808080; color: #fff; }
        
        /* *** 修改點 1：移除 .safe 樣式，新增 .successful 樣式 *** */
        .player.successful {
            background-color: #007bff; /* 成功的藍色 */
            color: #fff;
        }
        
        #info-display, #setup-container h1 {
            font-size: 1.5em;
            margin-bottom: 15px;
        }
        #message {
            font-size: 1em;
            color: #B22222;
            height: 25px;
        }
        button, input {
            font-size: 1.2em;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        button { cursor: pointer; color: white; border: none; }
        #setupButton, #startButton { background-color: #4CAF50; }
        #restartButton { background-color: #f44336; }
        button:hover { opacity: 0.9; }

    </style>
</head>
<body>

    <div id="setup-container" class="container">
        <h1>設定遊戲人數</h1>
        <p>請輸入玩家人數 (2-9人)，然後開始。</p>
        <input type="number" id="playerCountInput" min="2" max="9" value="4">
        <button id="setupButton">設定完成，進入遊戲</button>
    </div>

    <div id="game-container" class="container" style="display: none;">
        <h1>水底危機</h1>
        <div id="info-display">
            時間剩下: <span id="timer">30</span> 秒
            <p id="message">按下開始鍵，遊戲即將開始！</p>
        </div>
        
        <div id="game-screen">
            <div id="surface"></div>
            <div id="underwater"></div>
        </div>
        
        <button id="startButton">開始遊戲</button>
        <button id="restartButton" style="display: none;">重新開始</button>
    </div>

    <script>
        // (元素獲取與遊戲狀態變數不變)
        const setupContainer = document.getElementById('setup-container');
        const gameContainer = document.getElementById('game-container');
        const playerCountInput = document.getElementById('playerCountInput');
        const setupButton = document.getElementById('setupButton');
        const timerDisplay = document.getElementById('timer');
        const messageDisplay = document.getElementById('message');
        const startButton = document.getElementById('startButton');
        const restartButton = document.getElementById('restartButton');
        const gameScreen = document.getElementById('game-screen');

        let playerCount = 0;
        let players = [];
        let timeLeft = 30;
        let gameInterval = null;
        let gameInProgress = false;

        // (setupGame 函式不變)
        function setupGame() {
            const count = parseInt(playerCountInput.value);
            if (count >= 2 && count <= 9) {
                playerCount = count;
                setupContainer.style.display = 'none';
                gameContainer.style.display = 'block';
                resetGameToInitialState();
                initializeGame();
            } else {
                alert('請輸入 2 到 9 之間的數字！');
            }
        }

        // --- 初始化遊戲畫面的函式 (*** 修改點 2：新增 isSuccessful 屬性 ***) ---
        function initializeGame() {
            gameScreen.querySelectorAll('.player').forEach(p => p.remove());
            players = [];

            for (let i = 1; i <= playerCount; i++) {
                const playerElement = document.createElement('div');
                playerElement.id = `player${i}`;
                playerElement.className = 'player';
                playerElement.textContent = i;
                const spacing = 100 / (playerCount + 1);
                playerElement.style.left = `${spacing * i}%`;
                gameScreen.appendChild(playerElement);
                // 新增 isSuccessful 屬性，用來追蹤玩家是否在正確時間浮出水面
                players.push({ id: i, element: playerElement, status: 'alive', isSuccessful: false });
            }
        }
        
        // (startGame 函式不變)
        function startGame() {
            if (gameInProgress) return;
            gameInProgress = true;
            startButton.style.display = 'none';
            messageDisplay.textContent = '遊戲開始！';
            players.forEach(p => p.element.classList.add('submerged'));
            gameInterval = setInterval(updateTimer, 1000);
        }

        // --- 每秒更新計時器的函式 (*** 修改點 3：更新提示訊息 ***) ---
        function updateTimer() {
            timeLeft--;
            timerDisplay.textContent = timeLeft;
            
            // 根據新的規則更新提示
            if (timeLeft > 10) {
                 messageDisplay.textContent = '等待正確時機...';
            } else if (timeLeft <= 9 && timeLeft >= 8) {
                // 第22秒到第23秒初 (倒數, 9, 8秒)
                messageDisplay.textContent = '就是現在！浮出水面成為成功者！';
            }  else if (timeLeft <= 6 && timeLeft >= 5) {
                // 毒氣釋放時間調整為時機窗之後
                messageDisplay.textContent = '注意！水中釋放毒氣！';
                players.forEach(p => {
                    if (p.element.classList.contains('submerged') && p.status === 'alive') {
                        p.status = 'dead';
                        p.element.classList.add('dead');
                        p.element.textContent = 'X';
                    }
                });
            } 

            if (timeLeft <= 0) {
                endGame();
            }
        }

        // --- 遊戲結束的函式 (*** 修改點 4：更新結束訊息與勝利條件 ***) ---
        function endGame() {
            clearInterval(gameInterval);
            gameInProgress = false;

            // 1. 修改顯示文字
            let finalMessage = '遊戲結束！成功者：';
            // 2. 修改篩選條件，從 p.status === 'alive' 改為 p.isSuccessful
            const winners = players.filter(p => p.isSuccessful).map(p => p.id);
            
            if (winners.length > 0) {
                finalMessage += winners.join(', ');
            } else {
                finalMessage += '無';
            }
            messageDisplay.textContent = finalMessage;
            restartButton.style.display = 'inline-block';
        }
        
        // --- 讓玩家浮出水面的函式 (*** 修改點 5：更新成功條件判斷 ***) ---
        function surfacePlayer(playerNumber) {
            if (!gameInProgress || playerNumber < 1 || playerNumber > playerCount) return;
            const player = players[playerNumber - 1];
            
            if (player && player.status === 'alive') {
                player.element.classList.remove('submerged');
                
                // 移除舊的 'safe' 邏輯
                // 新增 'successful' 邏輯：檢查時間是否在倒數 10, 9, 8 秒之間
                if (timeLeft <= 10 && timeLeft >= 8) {
                    player.isSuccessful = true;
                    player.element.classList.add('successful'); // 加上成功樣式
                }
            }
        }
        
        // (returnToSetup 和 resetGameToInitialState 函式不變)
        function returnToSetup() {
            gameContainer.style.display = 'none';
            setupContainer.style.display = 'block';
        }

        function resetGameToInitialState() {
            clearInterval(gameInterval);
            timeLeft = 30;
            gameInProgress = false;
            timerDisplay.textContent = 30;
            messageDisplay.textContent = '按下開始鍵，遊戲即將開始！';
            startButton.style.display = 'inline-block';
            restartButton.style.display = 'none';
        }

        // (監聽事件不變)
        setupButton.addEventListener('click', setupGame);
        startButton.addEventListener('click', startGame);
        restartButton.addEventListener('click', returnToSetup);
        
        document.addEventListener('keydown', (event) => {
            const key = parseInt(event.key);
            if (!isNaN(key)) {
                surfacePlayer(key);
            }
        });

    </script>
</body>
</html>